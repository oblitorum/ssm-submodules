#!/usr/bin/make -f
# -*- makefile -*-
# Sample debian/rules that uses debhelper.
# This file was originally written by Joey Hess and Craig Small.
# As a special exception, when this file is copied by dh-make into a
# dh-make output file, you may use that output file without restriction.
# This special exception was added by Craig Small in version 0.37 of dh-make.

# Uncomment this to turn on verbose mode.
export DH_VERBOSE=1

%:
	dh $@

TMP=$(CURDIR)/debian/tmp

export GOPATH=$(CURDIR)/go
export GO111MODULE=off
export GOROOT=/usr/lib/go-1.17
export PATH:=/usr/lib/go-1.17/bin:$(PATH)

override_dh_auto_build:
	mkdir -p $(GOPATH)/src/github.com/prometheus
	mkdir -p $(GOPATH)/src/github.com/percona
	mkdir -p $(GOPATH)/src/github.com/shatteredsilicon
	mkdir -p $(GOPATH)/src/github.com/google/go-github
	mkdir -p $(GOPATH)/bin

	tar -C $(GOPATH)/src/github.com/percona -zxf $(CURDIR)/mongodb_exporter-*.tar.gz
	tar -C $(GOPATH)/src/github.com/percona -zxf $(CURDIR)/node_exporter-*.tar.gz
	tar -C $(GOPATH)/src/github.com/percona -zxf $(CURDIR)/percona-toolkit-*.tar.gz
	tar -C $(GOPATH)/src/github.com/percona -zxf $(CURDIR)/pid-watchdog-*.tar.gz
	tar -C $(GOPATH)/src/github.com/percona -zxf $(CURDIR)/postgres_exporter-*.tar.gz
	tar -C $(GOPATH)/src/github.com/percona -zxf $(CURDIR)/proxysql_exporter-*.tar.gz
	tar -C $(GOPATH)/src/github.com/percona -zxf $(CURDIR)/qan-agent-*.tar.gz
	tar -C $(GOPATH)/src/github.com/shatteredsilicon -zxf $(CURDIR)/mysqld_exporter-*.tar.gz
	tar -C $(GOPATH)/src/github.com/shatteredsilicon -zxf $(CURDIR)/pmm-client-*.tar.gz
	tar -C $(GOPATH)/src/github.com/google/go-github -zxf $(CURDIR)/go-github-*.tar.gz
	tar -C $(GOPATH)/src/github.com/prometheus -zxvf $(CURDIR)/promu-*.tar.gz

	cd $(GOPATH)/src/github.com/percona && \
		mv mongodb_exporter-*	mongodb_exporter && \
		mv postgres_exporter-*	postgres_exporter && \
		mv proxysql_exporter-*	proxysql_exporter && \
		mv node_exporter-*		node_exporter && \
		mv percona-toolkit-*	percona-toolkit && \
		mv pid-watchdog-*		pid-watchdog && \
		mv qan-agent-*			qan-agent

	cd $(GOPATH)/src/github.com/shatteredsilicon && \
		mv mysqld_exporter-*	mysqld_exporter && \
		mv pmm-client-*		pmm-client


	cd $(GOPATH)/src/github.com/google/go-github && \
		mv go-github-* v25

	cd $(GOPATH)/src/github.com/prometheus && \
		ln -s ../percona/node_exporter node_exporter && \
		mv promu-* promu && \
		cd promu && \
		make build

	cd $(GOPATH)/src/github.com/percona/node_exporter && \
		make -j$(NPROCS) build && \
		mv ssm-submodules $(GOPATH)/bin/node_exporter
	cd $(GOPATH)/src/github.com/percona/postgres_exporter && \
		go build github.com/percona/postgres_exporter/cmd/postgres_exporter && \
		mv postgres_exporter $(GOPATH)/bin
	cd $(GOPATH)/src/github.com/percona/percona-toolkit && \
		GO111MODULE=on go mod download && \
		GO111MODULE=on go build ./src/go/pt-mongodb-summary && \
		cp pt-mongodb-summary $(GOPATH)/bin && \
		cp bin/pt-mysql-summary $(GOPATH)/bin && \
		cp bin/pt-summary $(GOPATH)/bin

	go install -ldflags="-s -w" github.com/percona/mongodb_exporter
	go install -ldflags="-s -w" github.com/percona/proxysql_exporter
	go install -ldflags="-s -w" github.com/shatteredsilicon/pmm-client
	go install -ldflags="-s -w" github.com/shatteredsilicon/mysqld_exporter
	go install -ldflags="-s -w" github.com/percona/pid-watchdog
	go install -ldflags="-s -w" github.com/percona/qan-agent/bin/...

override_dh_auto_install:
	@echo "RULES.$@"
	mkdir -p $(TMP)
	cp $(GOPATH)/bin/pmm-client $(TMP)/pmm-admin
	cp -f $(GOPATH)/bin/node_exporter $(TMP)/node_exporter
	cp -f $(GOPATH)/bin/mysqld_exporter $(TMP)/mysqld_exporter
	cp -f $(GOPATH)/bin/postgres_exporter $(TMP)/postgres_exporter
	cp -f $(GOPATH)/bin/mongodb_exporter $(TMP)/mongodb_exporter
	cp -f $(GOPATH)/bin/proxysql_exporter $(TMP)/proxysql_exporter
	cp -f $(GOPATH)/bin/percona-qan-agent $(TMP)/percona-qan-agent
	cp -f $(GOPATH)/bin/percona-qan-agent-installer $(TMP)/percona-qan-agent-installer
	cp -f $(GOPATH)/bin/pt-summary $(TMP)/pt-summary
	cp -f $(GOPATH)/bin/pt-mysql-summary $(TMP)/pt-mysql-summary
	cp -f $(GOPATH)/bin/pt-mongodb-summary $(TMP)/pt-mongodb-summary
	install -m 0644 $(GOPATH)/src/github.com/shatteredsilicon/mysqld_exporter/queries-mysqld.yml $(TMP)/queries-mysqld.yml
	install -m 0755 $(GOPATH)/src/github.com/percona/node_exporter/example.prom $(TMP)/example.prom

override_dh_usrlocal:
